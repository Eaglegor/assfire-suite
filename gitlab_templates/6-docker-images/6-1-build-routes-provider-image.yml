.build-routes-provider-server-image:
  image: docker:stable
  services:
    - docker:dind
  variables:
    IMAGE_TAG_NAME: latest
  stage: build_docker_images
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build out/install/assfire-router/ -f routes_provider/Dockerfile -t $CI_REGISTRY/assfire/assfire-suite/assfire-router:${IMAGE_TAG_NAME}
    - docker push $CI_REGISTRY/assfire/assfire-suite/assfire-router:${IMAGE_TAG_NAME}

build-routes-provider-server-image-master:
  extends: .build-routes-provider-server-image
  variables:
    IMAGE_TAG_NAME: latest
  dependencies: 
    - build-project-master
  only:
    refs:
      - master
  needs:
    - build-project-master
    - run-unit-tests-routes-provider-server-master
    - run-routes-provider-client-server-integration-tests-master

build-routes-provider-server-image-tag:
  extends: .build-routes-provider-server-image
  variables:
    IMAGE_TAG_NAME: ${CI_COMMIT_TAG}
  dependencies: 
    - build-project-master
  only:
    refs:
      - tags
  needs:
    - build-project-master
    - run-unit-tests-routes-provider-server-master
    - run-routes-provider-client-server-integration-tests-master
    - run-routes-provider-redis-cache-integration-tests-master

build-routes-provider-server-image-branch:
  extends: .build-routes-provider-server-image
  variables:
    IMAGE_TAG_NAME: ${CI_COMMIT_REF_SLUG}-tmp
  dependencies: 
    - build-project-branch
  only:
    refs:
      - branches
      - merge_requests
  except:
    refs:
      -  master
  needs: 
    - build-project-branch
    - run-unit-tests-routes-provider-server-branch
    - run-routes-provider-client-server-integration-tests-branch
    - run-routes-provider-redis-cache-integration-tests-branch

.build-routes-provider-maptest-image:
  image: docker:stable
  services:
    - docker:dind
  variables:
    IMAGE_TAG_NAME: latest
  stage: build_docker_images
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - cd routes_provider/tools/maptest
    - docker build . -t $CI_REGISTRY/assfire/assfire-suite/assfire-router-maptest:${IMAGE_TAG_NAME}
    - docker push $CI_REGISTRY/assfire/assfire-suite/assfire-router-maptest:${IMAGE_TAG_NAME}

build-routes-provider-maptest-image-master:
  extends: .build-routes-provider-maptest-image
  variables:
    IMAGE_TAG_NAME: latest
  dependencies:
    - build-routes-provider-maptest-tool-master
  only:
    refs:
      - master
  needs:
    - build-routes-provider-maptest-tool-master

build-routes-provider-maptest-image-tag:
  extends: .build-routes-provider-maptest-image
  variables:
    IMAGE_TAG_NAME: ${CI_COMMIT_TAG}
  dependencies:
    - build-routes-provider-maptest-tool-master
  only:
    refs:
      - tags
  needs:
    - build-routes-provider-maptest-tool-master

build-routes-provider-maptest-image-branch:
  extends: .build-routes-provider-maptest-image
  variables:
    IMAGE_TAG_NAME: ${CI_COMMIT_REF_SLUG}-tmp
  dependencies:
    - build-routes-provider-maptest-tool-branch
  only:
    refs:
      - branches
      - merge_requests
  except:
    refs:
      -  master
  needs:
    - build-routes-provider-maptest-tool-branch
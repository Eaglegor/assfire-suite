---
- name: Ensure namespaces are present
  hosts: localhost
  connection: local
  collections:
    - community.kubernetes
  tasks:
    - name: Create assfire namespace
      community.kubernetes.k8s:
        name: assfire
        api_version: v1
        kind: Namespace
        state: present

- name: Ensure persistent volumes are available for redis
  hosts: redis_nodes
  tasks:
    - name: Ensure /opt/pvc dir is present
      file:
        path: /opt/pvc
        state: directory
    - name: Check if /opt/pvc/vd0 file exists
      stat:
        path: /opt/pvc/vd0
      register: vd0
    - name: Create /opt/pvc/vd0 file
      shell:
        cmd: dd if=/dev/zero of=/opt/pvc/vd0 bs=1M count=1024
      when: not vd0.stat.exists
    - name: Create ext4 fs on /opt/pvc/vd0
      filesystem:
        fstype: ext4
        dev: /opt/pvc/vd0
    - name: Make mount point for /mnt/disks/vd0
      file:
        path: /mnt/disks/vd0
        state: directory
    - name: Mount /opt/pvc/vd0 to /mnt/disks
      mount:
        path: /mnt/disks/vd0
        src: /opt/pvc/vd0
        state: mounted
        fstype: ext4

- name: Ensure redis is deployed
  hosts: localhost
  connection: local
  collections:
    - community.kubernetes
  tasks:
    - name: Ensure redis installation exists
      community.kubernetes.helm:
        chart_ref: redis
        chart_version: 10.7.16
        chart_repo_url: "https://charts.bitnami.com/bitnami"
        release_name: assfire-geocache
        release_state: present
        release_namespace: assfire
        release_values:
          master:
            nodeSelector: {"redis_role":"master"}
            persistence:
                storageClass: redis-storage
          slave:
            nodeSelector: {"redis_role":"slave"}
            persistence:
                storageClass: redis-storage

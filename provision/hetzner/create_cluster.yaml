---
- name: Provision VMs using Terraform
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Run terraform
      terraform:
          project_path: "{{playbook_dir}}/terraform"
          state: present
    - name: Refresh ansible inventory
      meta: refresh_inventory

- name: Wait until all nodes are up
  hosts: k8s-cluster
  gather_facts: no
  tasks:
      - name: Waiting until host is up
        wait_for_connection:

- name: Add floating IP configs to ingress nodes
  hosts: ingress
  gather_facts: no
  tasks:
    - name: Create configuration
      template:
        src: floating_ip.tmpl
        dest: /etc/sysconfig/network-scripts/ifcfg-eth0:1
    - name: Restart network
      service:
        name: network
        state: restarted

- name: Ensure kubernetes is deployed
  import_playbook: kubespray/cluster.yml

- name: Ensure redis is deployed
  gather_facts: no
  hosts: localhost
  connection: local
  collections:
    - community.kubernetes
  tasks:
    - name: Ensure redis installation exists
      community.kubernetes.helm:
        chart_ref: redis-cluster
        chart_version: 3.1.3
        chart_repo_url: "https://charts.bitnami.com/bitnami"
        name: assfire
        state: present
        namespace: kube-system
        values:
          timeout: 600
          cluster.nodes: 1
          cluster.replicas: 0
          redis.nodeSelector:
            redis_role: master
